# Implementation Plan: Traversal Performance Optimization

**Branch**: `001-optimize-traversal` | **Date**: 2025-11-01 | **Spec**: `/specs/001-optimize-traversal/spec.md`
**Input**: Feature specification from `/specs/001-optimize-traversal/spec.md`

**Note**: Generated via `/speckit.plan`; reflects latest clarifications including 6 MB binary cap.

## Summary

Accelerate directory traversal so the CLI hits a 3-second p95 SLO for 90k-entry local scans while preserving output parity and keeping the stripped release binary ≤ 6 MB. We will introduce filesystem-aware traversal strategies (Win32 `FindFirstFileExW` + large fetch, POSIX `openat`/`getdents64` via `rustix`) coordinated through a `rayon` work-stealing queue, extend progress reporting for slow media, and maintain a legacy fallback flag with automated parity checks.

## Technical Context

**Language/Version**: Rust 1.90 (Edition 2024)  
**Primary Dependencies**: `rayon` for parallel traversal, `windows` crate for Win32 APIs, `rustix` for POSIX directory iteration, existing `serde`/`clap` stack  
**Storage**: N/A (enumerates filesystem metadata only)  
**Testing**: `cargo test`, integration suites under `tests/`, targeted perf benches via `scripts/benchmark.sh`, regression comparisons between optimized and legacy modes  
**Target Platform**: Windows (NTFS), macOS (APFS), Linux (ext4/xfs) on baseline NVMe SSD hardware  
**Project Type**: Rust CLI binary (`dua`) with shared library crate  
**Performance Goals**: p95 ≤ 3 s for 90k local entries, ≤ 30 s for 1 M entries, CPU utilization ≤ 75% per core, steady progress updates ≥ every 2 s on slow media  
**Constraints**: Release binary ≤ 6 MB stripped, no unsafe panics, legacy output deltas ≤ max(1%, 10 MB)  
**Scale/Scope**: Single CLI with traversal engine refactor, touching up to ~8 modules plus new strategy-specific submodules and tests for datasets up to 1 M entries

## Constitution Check

All gates satisfied at planning stage:

- Code Quality: Plan scopes new traversal modules (`src/services/traverse/*`) with documented invariants, avoids unchecked `unwrap` by funneling IO errors through existing error types, and keeps strategy selection encapsulated.
- Testing: Each user story maps to new integration benchmarks (NTFS/APFS/ext4), parity tests between optimized and legacy paths, and additional unit coverage for strategy selectors; coverage commitments remain ≥ 90% for touched modules.
- UX Consistency: `--legacy-traversal` flag documented, auto-strategy reporting surfaced via progress/verbose output, and JSON progress schema extended without breaking existing keys.
- Performance: Bench datasets defined per platform, scripts updated to record before/after metrics, and binary-size gate enforced through feature pruning and post-build stripping in CI.

## Project Structure

### Documentation (this feature)

```text
specs/001-optimize-traversal/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md          # to be generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── cli/
│   ├── args.rs        # add strategy override flag wiring
│   └── output.rs      # surface selected strategy in verbose/progress modes
├── io/
│   └── snapshot.rs    # ensure progress snapshots capture strategy + pacing data
├── services/
│   ├── aggregate.rs   # verify thread-safe aggregation tweaks
│   ├── format.rs      # keep human/JSON output parity
│   ├── size.rs        # update size accumulation helpers for parallel use
│   └── traverse/
│       ├── mod.rs     # new strategy registry & dispatcher
│       ├── strategy.rs# trait + invariants shared by backends
│       ├── windows.rs # Win32 large-fetch implementation
│       ├── posix.rs   # rustix/openat traversal
│       └── progress.rs# progress throttling & reporting hooks
└── lib.rs             # expose new traversal API surface

tests/
├── integration/
│   ├── test_scan.rs           # add NTFS/APFS/ext4 strategy assertions
│   ├── test_perf_smoke.rs     # benchmark guardrails + binary size check harness
│   └── test_resilience.rs     # slow media progress + cancellation cases
├── contract/
│   └── test_snapshot_json.rs  # ensure JSON progress schema backward compatible
└── unit/
    ├── traverse_tests.rs      # extend with strategy selection/unit coverage
    └── aggregate_tests.rs     # validate concurrent totals
```

**Structure Decision**: Retain single-crate CLI layout; add `src/services/traverse/` submodules for filesystem-specific strategies and extend existing CLI/tests directories without introducing new top-level packages.

## Complexity Tracking

No constitution waivers required; complexity remains within existing module boundaries.
