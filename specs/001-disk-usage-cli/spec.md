# Feature Specification: Disk Usage CLI MVP

**Feature Branch**: `001-disk-usage-cli`  
**Created**: 2025-10-30  
**Status**: Draft  
**Input**: User description: "ストレージの使用量が多すぎるが、どこが使用しているか把握できない。それが把握できるCLIツールが欲しい。各ディレクトリ毎の使用量がわかる。深掘りできる。非常に大量のファイル（最大1000万）でも処理できる。Windows, Linux, MacOS(Optional)。メモリ使用量が少ない。高速。可能ならファイルシステムに合わせた最適化。分析と表示を分ける案。表示方法はCLI/HTML/SVG/GUIなど候補。MVPから、様々な出力方法に拡張しやすい柔軟な作り。"
# Feature Specification: Disk Usage CLI MVP

**Feature Branch**: `001-disk-usage-cli`  
**Created**: 2025-10-30  
**Status**: Draft  
**Input**: ユーザー要望の要旨: ストレージ使用量の全体把握と深掘りができ、超大規模（最大1,000万ファイル）にも耐える軽量・高速なCLIツール。分析（走査）と表示を分離でき、将来的に多様な出力へ拡張可能。主要OS（Windows/Linux、可能ならMacOS）対応。

## Clarifications

### Session 2025-10-30

- Q: スナップショットの保存形式 → A: Parquet（.parquet）
- Q: シンボリックリンク/ジャンクションを既定で辿るか → A: 辿らない（not follow）
- Q: 除外パターンのMVP範囲 → A: 最小限の内蔵除外のみ（ユーザー定義なし）
- Q: ファイルシステム境界の扱い → A: 既定では越えない（同一デバイスのみに限定）
- Q: MVPの出力形式（CLI） → A: Textのみ（Markdown風箇条書き）。将来拡張でHTML/SVG/JSONを追加可能なレンダラー抽象を用意。
- Q: サイズ基準のデフォルト → A: 実使用サイズ（physical）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ディレクトリ使用量の把握 (Priority: P1)

ユーザーは任意のルートディレクトリを指定し、その直下にある各サブディレクトリ（およびファイル）の合計使用量と項目数を一覧で確認できる。

**Why this priority**: 最初に「どこが大きいか」を瞬時に把握できることが最も価値が高く、以後の絞り込みの出発点になるため。

**Independent Test**: 既知のサイズ構成を持つテスト用ディレクトリに対して実行し、出力されたサイズ・件数が期待値と一致することを確認する。

**Acceptance Scenarios**:

1. Given 実在するディレクトリを引数に与えた, When コマンドを実行した, Then 直下の各項目の合計サイズと項目数が降順で表示される
2. Given 存在しないパスを指定した, When コマンドを実行した, Then エラーメッセージと非ゼロ終了コードが返る

---

### User Story 2 - ドリルダウンによる深掘り (Priority: P2)

ユーザーは一覧結果の中から気になるディレクトリを指定し、その配下について同様の集計を再実行して深掘りできる（階層の深さや対象の限定ができる）。

**Why this priority**: 問題の根本原因（肥大化している具体のディレクトリ）に素早く到達するために必要。

**Independent Test**: 任意のサブディレクトリを対象に再実行した結果が、当該ディレクトリのみをルートとした集計と一致することを確認する。

**Acceptance Scenarios**:

1. Given ルートで集計済み, When 指定したサブディレクトリについて再度集計した, Then その直下の一覧が表示される
2. Given 非常に深い階層構造, When 深さの上限を指定して集計した, Then 指定した深さまでの集計結果が表示される

---

### User Story 3 - スナップショットの保存と閲覧 (Priority: P2)

ユーザーは分析（走査）処理の結果をスナップショットとして保存し、後から同じ断面の結果を読み込み、絞り口を変えて閲覧できる。

**Why this priority**: 重い分析を何度も実行せずに済み、表示に集中できるため。時間とリソースの節約。

**Independent Test**: 同じデータセットに対して、保存→読み込み→表示の結果が当該時点の集計と一致することを検証する。

**Acceptance Scenarios**:

1. Given 大規模ディレクトリを分析した, When スナップショットを保存した, Then 後で読み込み直せる
2. Given 保存済みスナップショット, When 表示の並べ替えやフィルタを変えた, Then 再走査なしで結果が即時に変わる

---

### User Story 4 - 大規模環境での安定動作 (Priority: P3)

ユーザーは最大1,000万ファイル規模の環境でも、エラーや極端なメモリ逼迫なしに処理を完走できる。

**Why this priority**: 本ツールの主要価値（大規模でも使える）に直結するため。

**Independent Test**: 疑似データまたは実データで1,000万ファイル相当を用意し、走査が完了し、メモリ使用量と実行時間がSLO内であることを確認する。

**Acceptance Scenarios**:

1. Given 1,000万ファイル相当のデータセット, When 走査を開始した, Then 異常終了せず完走する
2. Given 走査中に一部ファイルが削除/追加された, When 処理が継続した, Then エラーで停止せず、影響を最小化して完了する

---

### Edge Cases

- 権限不足のディレクトリ/ファイルが混在する（アクセス不能・途中で権限エラー）
- 循環参照（シンボリックリンク、ジャンクション、再解析ポイント）
- ハードリンクにより同一内容が複数パスから参照される
- 非ASCII/非常に長いパス、区切り文字の違い（WindowsとLinux）
- 走査中のファイル更新/削除/作成（揮発性の高い一時領域）
- ネットワークドライブや遅延の大きいストレージ（タイムアウト/再試行）
- スパースファイルや圧縮/暗号化ファイル（論理サイズと物理サイズの差）
- 隠しファイルや除外対象（OSやユーザー設定で扱いが変わる）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 指定したパス配下を走査し、直下の各項目（ファイル/ディレクトリ）について「合計サイズ」「ファイル数」「ディレクトリ数」を集計して一覧表示できること。
- **FR-002**: 集計結果はサイズ降順などの並べ替えができ、ページングまたは上位N件の出力に対応すること（大量出力の安全性のため）。
- **FR-003**: 任意のサブディレクトリを新たな起点として再集計できること（ドリルダウン）。深さ上限の指定に対応すること。
- **FR-004**: 走査結果をスナップショットとして保存し、後から読み込んで再表示できること（再走査不要）。
	- 形式: Parquet（.parquet、列指向）。純Rust実装（parquet crate）を採用しクロスプラットフォームを確保。
	- スキーマ（初期版）: entries（path:string, size_bytes:u64, file_count:u32, dir_count:u32, depth:u16, parent_path:string?）, meta（scan_root:string, started_at:datetime, finished_at:datetime, size_basis:enum[logical,physical], hardlink_policy:enum[dedupe,count], excludes:string[]）。
	- 読み込み時は列プルーニングと述語プッシュダウンを活用して高速にフィルタ/並べ替え可能であること。
- **FR-005**: 処理不能な項目（権限不足/壊れたリンク等）があっても全体を中断せず、件数および代表エラーをレポートできること。
- **FR-006**: WindowsおよびLinuxで同等のコマンド操作と出力を提供すること（パス表記の差異は許容）。
- **FR-007**: 内蔵除外のみを提供すること（MVP）。危険/擬似ファイルシステム（例：Linuxの/proc, /sys, /dev, /run、一部仮想/ネットワークFS等）は既定で対象外。ユーザー定義の除外パターンはポストMVP。
- **FR-008**: 合計サイズの算出方針は一貫しており、ユーザーが選択した基準（論理サイズ/実使用サイズなど）で集計できること。
	- 既定値: 実使用サイズ（physical）。オプションで論理サイズへ切替可能。
- **FR-009**: ハードリンク/重複参照の扱い方針をユーザーが選択できること（重複カウント/可能な限りの一意化）。デフォルトは「一意化」とする。

- **FR-010**: シンボリックリンク/ジャンクションは既定で辿らない（not follow）。リンクターゲットは集計対象外とし、リンク自体はサイズ集計に含めない（表示は可）。

- **FR-011**: ファイルシステム境界は既定で越えない。起点パスと同一のデバイスID（st_dev等）に属する項目のみ走査対象とする（Windowsでは同一ボリューム）。

#### Acceptance Criteria (FR別)

- FR-001: 既知構成のテストディレクトリで、直下各項目の合計サイズ・件数が期待値と一致する。サイズは指定基準（論理/実使用）に従って再現可能である。
- FR-002: 並べ替え指定により順序が変わり、上位N件の制御により出力量が調整できる。大量出力でもエラーとならない。直下TOPプレビューのルール（K/M/E/S/A/R/D、深さ1段）が既定値で機能し、条件を満たす子のプレビューが同一出力内に表示される。
- FR-003: 任意サブディレクトリを起点とした再集計結果が、そのディレクトリを直接ルートにした場合と一致する。深さ上限の指定で結果が上限に収まる。
- FR-004: 保存したスナップショットを読み込んだ表示結果が保存時点の集計と一致し、読み込み時に再走査を行わない（走査I/Oが発生しない）。
- FR-005: 権限不足や壊れたリンクが含まれてもコマンドは非ゼロ終了とならず、エラー件数と代表例が最後に表示（または機械可読出力）される。
- FR-006: Windows/Linuxの双方で同等の操作・出力形式でP1/P2シナリオが通る。パス区切り等の差異によって機能が失われない。
- FR-007: 内蔵除外により、/procや/sys等の擬似FS配下は走査されない。既定状態でユーザーが追加パターンを指定する手段は存在しない。
- FR-008: サイズの基準（論理/実使用）を切り替えた際、同一データセットで数値が整合的に変化し、説明可能な差分となる。既定では実使用サイズとして動作し、スパース/圧縮ファイルで論理との差分が観測できる。
- FR-009: デフォルト方針決定後、同一ディレクトリに複数ハードリンクがあるケースで期待どおり（重複カウント or 一意化）の結果になる。
- FR-010: シンボリックリンク/ジャンクションを含むディレクトリで実行した際、リンク先の内容は集計されず、総サイズがリンク追従時より小さくなる。循環参照があっても停止しない。
- FR-011: 起点パスが属するファイルシステム外にあるマウントポイント/ジャンクション配下へは降りず、別FSの大容量データが結果に混入しない（Linuxでst_dev相違、Windowsでボリューム相違を検知）。

### Non-Functional Requirements *(mandatory)*

- **NFR-Perf**: 大規模（最大1,000万ファイル）でも完走でき、メモリのピーク使用量は1GB以下、p95の走査完了時間は標準的なSSD環境で100万ファイルあたり10分以内を目安とする（参考値、詳細は計測により調整）。
- **NFR-UX**: 初見でも使える分かりやすい出力（人が読める一覧）と、後続処理に使える機械可読な出力モードの両方を提供する（具体の形式や操作名は設計時に定義）。
	- 出力形式（MVP）: Textのみ（Markdown風箇条書き）。例:
		- / 50%
		  - /var 40%
		    - /var/lib 39%
		  - /usr 9%
	- 将来拡張: レンダラーを抽象化し、HTML/SVG/JSONを追加可能（MVP外）。
	- 直下TOPプレビュー: 対象パス直下の上位K（デフォルトK=10、簡易表示時=5）を表示し、条件を満たす子については同じ出力内で1段だけ自動プレビュー（その子直下の上位M、デフォルトM=3）を添える。プレビュー対象は最大E件（デフォルトE=3）。選定条件は以下のいずれか: 親に対する子サイズ比S%以上（デフォルトS=20%）/ 子の絶対サイズがA以上（デフォルトA=10GiB）/ 親での順位がR位以内（デフォルトR=3）かつ対象がルート級。偏在検知（親最大子/親合計≥D、デフォルトD=60%）がtrueなら、その最大子は必ずプレビュー。プレビュー深さは常に1段で固定。
- **NFR-Reliability**: 途中エラーは集約して報告し、全体処理は可能な限り継続する。中断時は再開しやすいように部分結果の再利用を考慮する。
- **NFR-Compatibility**: 主要ファイルシステムの一般的な特性差（大小文字の扱い、メタ情報、リンクの種類）に対して、動作が破綻しないこと。
- **NFR-Observability**: 進捗表示（件数・推定残り時間など）と、詳細ログレベルの切り替えが可能であること。
- **NFR-Testing**: ユーザーストーリーごとに独立して受け入れテストを用意し、主要パスについては自動化する。

### Key Entities *(include if feature involves data)*

- **DirectorySummary**: パス、合計サイズ、ファイル数、ディレクトリ数、集計時刻。
- **ScanError**: パス、原因（種別/メッセージ）、発生時刻。
- **Snapshot**: 走査時のメタデータおよび集計結果の断面。フィルタ/並べ替えは読み取り時に適用可能。
	- 保存形式: Parquet。entriesテーブル（上記スキーマ）とmetaテーブルを想定（単一ファイル内の複数Row Group/Logical tableで表現）。
	- 目的: 再走査なしで直下TOPプレビューや並べ替え/フィルタを再構成可能。

### Assumptions

- MVPでは表示はCLIの一覧に集中し、インタラクティブなグラフィカル出力は将来拡張とする。
- MacOS対応はベストエフォート（主要機能は動作させるが、優先度はWindows/Linuxより下）。
- スナップショットは必須ではなく任意機能とする（ディスク使用量はデータ規模に比例し得るため、保存前に概算サイズを提示する）。
	- スナップショットにはディレクトリ単位の集計（path, size, file_count, dir_count, depth, 親子関係の手掛かり）を保存し、読み込み時に直下TOPやフィルタ・並べ替えを再構成できるようにする。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは任意のディレクトリに対して上位ディレクトリの使用量ランキングを1回の実行で確認できる（P1シナリオを完了）。
- **SC-002**: 100万ファイル規模の走査で、p95の完了時間が10分以内、かつメモリピークが1GB未満であること（標準的なSSD/CPU環境の目安）。
- **SC-003**: 10件以上の権限エラーやリンク問題が混在する環境でも、処理が中断せず結果が得られ、発生件数と代表例が出力されること。
- **SC-004**: WindowsとLinuxの双方で、P1およびP2の受け入れシナリオが再現できること（同等の操作と結果の整合性）。
- **SC-005**: スナップショット保存→読み込み→表示の一連の操作が再現可能で、読み込み時に再走査を行わないことが確認できること。
	- 表示はMVPではText（Markdown風）で再現されること。
